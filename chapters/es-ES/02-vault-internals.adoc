== Capítulo 2: Arquitectura interna de Vault

En este capítulo explicaremos y analizaremos el funcionamiento interno de redborder Vault.

=== Ruta de datos

Desde que los datos son recolectados hasta que son mostrados a través de la interfaz de usuario, pasa por tres fases para facilitar la recolección, el procesado y visualización de los datos.

Cada una de estas fases tiene un peso significativo y son críticas para el correcto funcionamiento de redborder Vault.

==== Colector de logs

En esta primera fase se recolectan los logs de los distintos servicios, esto se hace utilizando la herramienta rsyslog. Una vez obtenidos los logs son clasificados por aplicación y posteriormente enviados a Kafka para su persistencia y posterior procesado.

image::https://raw.githubusercontent.com/redBorder/vault-documentation/master/assets/images/log-collector-details.png[Detalles del collector de logs]

En la imagen anterior podemos ver en detalle el proceso que sigue el recolector de log. Podemos resumir esta fase en cuatro pasos:

1. El primer paso consiste en la recepción de los logs de los diferentes servicios en rsyslog.
2. A continuación rsyslog procederá a buscar aquellos logs que haga match con una serie de reglas definidas con los logs más comunes y útiles.
3. Una vez que se ha buscado esos logs específicos, rsyslog los envía Kafka en formato JSON. Aquellos logs que no hagan match serán desechados.
4. Por último, al recibir Kafka los logs los almacena en su correspondiente topic para su posterior procesado.

==== Procesado de datos

En la fase de procesado de datos entra logstash. Gracias a logstash se hace la clasificación de los campos `target`, `status`, `source` y `action` en base a las reglas definidas por los logs, la definición de estos campos se puede encontrar en la tabla inferior. Los ejemplos expuestos son los obtenidos a partir de un servicio web apache:

[cols="^,^,^", options="header"]
|====
|*Campo*|*Definición*|*Ejemplo*
|action|Acción realizada| GET, POST, PUT, DELETE ...
|target|Objetivo de la acción realizada | https://redborder.com
|status|Efecto que ha tenido la acción | 200, 404, 503 ...
|source|Origen de la acción| 24.109.71.77
|====

Una vez que se han identificado los distintos campos y se ha normalizado la información logstash la envía al entorno de redborder donde pasarán a indexarse.

==== Visualización de datos

Tras el procesado de datos estarán disponibles para su consulta y seguimiento en la web de redborder.
